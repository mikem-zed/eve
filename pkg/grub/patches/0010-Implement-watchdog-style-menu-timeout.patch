From cfa51e14d67c80d94c8e9d289233d2adb0368ff7 Mon Sep 17 00:00:00 2001
From: Michael Malyshev <mikem@zededa.com>
Date: Tue, 31 Aug 2021 16:24:08 +0300
Subject: [PATCH] Implement watchdog style menu timeout

---
 grub-core/normal/main.c |  2 +-
 grub-core/normal/menu.c | 10 +++++++---
 2 files changed, 8 insertions(+), 4 deletions(-)

diff --git a/grub-core/normal/main.c b/grub-core/normal/main.c
index 78a70a8bf..aaca74c25 100644
--- a/grub-core/normal/main.c
+++ b/grub-core/normal/main.c
@@ -208,7 +208,7 @@ grub_normal_init_page (struct grub_term_output *term,
  
   grub_term_cls (term);
 
-  msg_formatted = grub_xasprintf (_("GNU GRUB  version %s"), PACKAGE_VERSION);
+  msg_formatted = grub_xasprintf (_("v1 GNU GRUB version %s"), PACKAGE_VERSION);
   if (!msg_formatted)
     return;
  
diff --git a/grub-core/normal/menu.c b/grub-core/normal/menu.c
index e7a83c2d6..514212591 100644
--- a/grub-core/normal/menu.c
+++ b/grub-core/normal/menu.c
@@ -660,6 +660,7 @@ run_menu (grub_menu_t menu, int nested, int *auto_boot)
 
   current_entry = default_entry;
 
+  int initial_timeout_value = grub_menu_get_timeout ();  
  refresh:
   menu_init (current_entry, menu, nested);
 
@@ -702,9 +703,12 @@ run_menu (grub_menu_t menu, int nested, int *auto_boot)
 	{
 	  if (timeout >= 0)
 	    {
-	      grub_env_unset ("timeout");
-	      grub_env_unset ("fallback");
-	      clear_timeout ();
+	      //grub_env_unset ("timeout");
+	      //grub_env_unset ("fallback");
+	      //clear_timeout ();
+		grub_menu_set_timeout(initial_timeout_value);
+		menu_print_timeout (timeout);
+		timeout = initial_timeout_value;
 	    }
 
 	  switch (c)
-- 
2.25.1

